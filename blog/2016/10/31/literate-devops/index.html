<!DOCTYPE html>
<html lang="en">
<head>
  <title>literate-devops - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #ds-thread #ds-reset .ds-comment-body p a {color: #ff0;}
   #ds-thread #ds-reset .ds-comment-body p a:hover {color: #0ff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" href="http://lujun9972.github.io/emacs-document/media/css/main.css" type="text/css"/>
  <link rel="stylesheet" href="http://lujun9972.github.io/emacs-document/media/css/comment.css" type="text/css"/>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="http://lujun9972.github.io/emacs-document/">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;集思广益</p>
    <nav class="site-nav">
      <div class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z" fill="#ffff00"/>
          <path d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z" fill="#ffff00"/>
          <path d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z" fill="#ffff00"/>
        </svg>
      </div>
      <ul class="trigger">
        <li><a href="http://lujun9972.github.io/emacs-document/years/">Years</a></li>
        <li><a href="http://lujun9972.github.io/emacs-document/authors/">Authors</a></li>
        <li><a href="http://lujun9972.github.io/emacs-document/tags/">Tags</a></li>
        <li><a href="http://lujun9972.github.io/emacs-document/about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document">Github</a></li>
        <li><a href="http://lujun9972.github.io/emacs-document/rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">literate-devops</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgheadline1">1. Tell us a Story</a></li>
<li><a href="#orgheadline2">2. Literate Devops</a></li>
<li><a href="#orgheadline5">3. What about the Virtual Machine?</a>
<ul>
<li><a href="#orgheadline3">3.1. Tramp to the Rescue</a></li>
<li><a href="#orgheadline4">3.2. Using org-mode Sessions</a></li>
</ul>
</li>
<li><a href="#orgheadline6">4. What about Verbose Commands?</a></li>
<li><a href="#orgheadline7">5. Can you Use the Output?</a></li>
<li><a href="#orgheadline8">6. Setting Variables and Values</a></li>
<li><a href="#orgheadline9">7. Communicating with Others</a></li>
<li><a href="#orgheadline10">8. Summary</a></li>
<li><a href="#orgheadline11">9. Footnotes:</a></li>
</ul>
</div>
</div>
<p>
Maintaining servers falls into two phases:
</p>

<ol class="org-ol">
<li>Bang head until server works</li>
<li>Capture effort into some automation tool like Puppet or Chef.</li>
</ol>

<p>
Recently, I’ve been playing around with making the first phase closer to the
second. For lack of a better word, I’m calling it literate devops.
</p>

<p>
I’ve talked about using <a href="http://howardism.org/Technical/LP/introduction.html">org-mode’s literate programming model</a> to investigate
new ideas and crystallize thoughts, and this approach appears to work well for
me since I lack those esoteric sysadmin skills.
</p>

<div id="outline-container-orgheadline1" class="outline-2">
<h2 id="orgheadline1"><span class="section-number-2">1</span> Tell us a Story</h2>
<div class="outline-text-2" id="text-1">
<p>
Once upon a time, I was tasked with patching an RPM, which is not in my
comfort zone, so my initial plan of attack was:
</p>

<ol class="org-ol">
<li>Use Vagrant to create a disposable CentOS system</li>
<li>SSH into this virtual machine to download needed tools</li>
<li>Run various unknown commands</li>
<li>Rinse and repeat this step until successful</li>
</ol>

<p>
Of course, once I figure out the solution, I need to document it for others on
my team, and maybe create a repeatedable script.
</p>

<p>
First step is well documented elsewhere, but today I learned (TIL) you can ssh
directly to your Vagrant-based virtual machine with this little magic (Note: 
client is the name of my virtual machine I specified in the Vagrantfile):
</p>

<div class="org-src-container">

<pre class="src src-sh">vagrant ssh-config --host clientvm &gt;&gt; $<span style="color: #7590db;">HOME</span>/.ssh/config
</pre>
</div>

<p>
This command appends some lovely host-connection magic so you can issue: ssh
clientvm
</p>
</div>
</div>

<div id="outline-container-orgheadline2" class="outline-2">
<h2 id="orgheadline2"><span class="section-number-2">2</span> Literate Devops</h2>
<div class="outline-text-2" id="text-2">
<p>
Instead of opening up a terminal to my virtual machine, I pop into Emacs and
load this sprint’s note file^<a href="http://howardism.org/Technical/Emacs/literate-devops.html#fn.1">1</a>, create a new header, and enter the shell and
ruby commands in this text file.
</p>

<p>
What good is this? Unlike a traditional terminal, this allows me to log, 
document and execute each command.
</p>

<p>
For instance, here is a screen-shot of a section of my Emacs buffer:
</p>


<div class="figure">
<p><img src="http://howardism.org/Technical/Emacs/literate-devops.png" alt="literate-devops.png" />
</p>
</div>

<p>
As an old bear with very little brains, my prose can explain the background
and purpose of each command. Clicking the hyperlink refreshes my memory of
previous discoveries. A keychord executes the code block…
</p>

<p>
Yes. I execute the commands from within Emacs.
</p>

<p>
Hitting C-c C-c (Control-C twice) runs the code (based on the language). This
example runs in the shell. The results are placed back into the file, which
can be used by other code blocks (and <a href="http://orgmode.org/manual/results.html#results">many other options</a>).
</p>

<p>
For instance, here is the first half of a section for downloading the GPG Keys
from a repository (the URL is placed in a property that is shared among all
code blocks in his section):
</p>


<div class="figure">
<p><img src="http://howardism.org/Technical/Emacs/literate-devops-14.png" alt="literate-devops-14.png" />
</p>
</div>

<p>
The Shell script block (in the center of the screen-shot) uses wget to
download the HTML index file and parse and extract the key file URLs. We’ll
have a Ruby script do that parsing, and since the script may be a bit hairy,
we’ll define it in another code block.
</p>

<p>
One technique from <a href="http://howardism.org/Technical/LP/introduction.html">literate programming</a> is the idea that one code block can be
inserted into another block (the reference is a name within double angle
brackets, <a id="orgtarget1"></a>). Donald Knuth called this feature WEB. Since it can
accidentally conflict with some languages (like Ruby), I have it off by
default, but turn it on for this block with the noweb parameter.
</p>

<p>
Here is the Ruby script. Having it in a separate Ruby-specific code block
allows me to turn on all the Ruby magic that Emacs can muster.
</p>


<div class="figure">
<p><img src="http://howardism.org/Technical/Emacs/literate-devops-15.png" alt="literate-devops-15.png" />
</p>
</div>

<p>
The last step is to take the URLs produced by the first script and feed them
to another Shell script that will call wget to download each:
</p>


<div class="figure">
<p><img src="http://howardism.org/Technical/Emacs/literate-devops-16.png" alt="literate-devops-16.png" />
</p>
</div>

<p>
The key-list was the name of our original code block, as well as the name of
its results. We assign that list of results to a variable, LIST that the shell
script would access as $LIST.
</p>

<p>
This example demonstrated how literate programming can weave code and data
through different languages.
</p>
</div>
</div>

<div id="outline-container-orgheadline5" class="outline-2">
<h2 id="orgheadline5"><span class="section-number-2">3</span> What about the Virtual Machine?</h2>
<div class="outline-text-2" id="text-3">
<p>
Normally, specifying sh as the code block’s language, tells Emacs to run the
code in my local system’s shell, but in this case, I want it ran on my virtual
machine (or on my development server in my lab). I’ll describe two options for
doing this, using <a href="http://www.emacswiki.org/TrampMode">Tramp</a> and Babel Sessions.
</p>
</div>

<div id="outline-container-orgheadline3" class="outline-3">
<h3 id="orgheadline3"><span class="section-number-3">3.1</span> Tramp to the Rescue</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Tramp is an Emacs feature that allows one to edit a file on a remote machine
using ssh and other protocols. For instance, running the find-file function
(bound to C-x C-f) lets you type something like:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">/ssh:howard.abrams@goblin.howardism.org:web/files/robot.txt
</pre>
</div>

<p>
If you put the following in your .emacs initialization file:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">setq</span> tramp-default-method <span style="color: #2d9574;">"ssh"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
And update your ~/.ssh/config file to know what user account goes with the
host name, the file reference above can be shorten to:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">/goblin.howardism.org:web/files/robot.txt
</pre>
</div>

<p>
Emacs looks for the : character to determine if Tramp should be invoked. Tramp
uses SSH keys if available, or will prompt you for a password if needed.
</p>

<p>
Each org-mode code block can specify a :dir option that specifies where the
code snippet should run, for instance, the following blocks are equivalent:
</p>


<div class="figure">
<p><img src="http://howardism.org/Technical/Emacs/literate-devops-9.png" alt="literate-devops-9.png" />
</p>
</div>

<p>
The :dir option allows full Tramp functionality, allowing me to run a block on
a different machine. Remember how I added my client Vagrant virtual machine to
my ~/.ssh/config file?
</p>


<div class="figure">
<p><img src="http://howardism.org/Technical/Emacs/literate-devops-10.png" alt="literate-devops-10.png" />
</p>
</div>

<p>
But I need access to my machine behind a firewall!?
</p>

<p>
My job deals with virtual machines running in a highly protected data center,
where I need to first log into jump boxes and bastion machines. Tramp handles
these sorts of hops. For instance:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">/ssh:10.98.18.229|ssh:10.0.1.122|sudo:/etc/network/interfaces
</pre>
</div>

<p>
Uses my account name to log into the bastion machine, and then uses my account
name to ssh into a virtual machine running in a private cloud. And then uses
the sudo command to let me edit a file owned by root.
</p>

<p>
Tramp pipe references works with the :dir option for org-mode source blocks:
</p>


<div class="figure">
<p><img src="http://howardism.org/Technical/Emacs/literate-devops-11.png" alt="literate-devops-11.png" />
</p>
</div>

<p>
Few tricks to keep in mind:
</p>

<ul class="org-ul">
<li>All but the last hop uses a pipe character, |, instead of the colon
character, :</li>
<li>If you use the pipe character, you need to specify all protocols, like
ssh, even if it is the default.</li>
<li>If your local machine’s operating system is different than the machine you
are connecting to, you need to fix a bug in org-mode, which I can show you
how to fix^<a href="http://howardism.org/Technical/Emacs/literate-devops.html#fn.2">2</a>.</li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline4" class="outline-3">
<h3 id="orgheadline4"><span class="section-number-3">3.2</span> Using org-mode Sessions</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Another approach is to create a session that connects different code blocks
together. Each screen shot below, each code block below has the same session
value, client (which is conveniently the same my virtual machine’s hostname,
client):
</p>


<div class="figure">
<p><img src="http://howardism.org/Technical/Emacs/literate-devops-2b.png" alt="literate-devops-2b.png" />
</p>
</div>

<p>
If I execute the first block, a shell is started in the background, and it
ssh’s into the machine. Note, to get this working, you need to enable 
password-less access by placing your SSH’s public key into the remote system’s
.ssh/authorized_keys file, or using the ssh Emacs package.^<a href="http://howardism.org/Technical/Emacs/literate-devops.html#fn.3">3</a>
</p>

<p>
From this point on, each code block I execute with the client session value,
uses this connection, and the code is executed on the remote machine (a
virtual machine in this case, but that doesn’t matter).
</p>

<p>
Either of these approaches works well, but the second approach, allows me to
set variables to create a particular state that other blocks may expect.
However, this requires execution of each block in order.
</p>

<p>
I have a third, more interactive, approach^<a href="http://howardism.org/Technical/Emacs/literate-devops.html#fn.4">4</a> using screen, but it doesn’t
allow passing variables to the code, and as you’ll see below, this is pretty
important to me.
</p>

<p>
Regardless, I continue learning how to accomplish my goal, all the while
documenting and validating my steps. The end result can be exported to web or
wiki page.
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline6" class="outline-2">
<h2 id="orgheadline6"><span class="section-number-2">4</span> What about Verbose Commands?</h2>
<div class="outline-text-2" id="text-4">
<p>
Yes, executing some commands can be quite time-consuming and verbose, but
often I need to search the results, and having the results placed in an Emacs
buffer allows better searching.
</p>

<p>
Often I use a collapsible “drawer” (which is just a way to identify the
beginning and end of the output):
</p>


<div class="figure">
<p><img src="http://howardism.org/Technical/Emacs/literate-devops-3.png" alt="literate-devops-3.png" />
</p>
</div>

<p>
Place the cursor on this drawer and hit the Tab key to hide or show the
output:
</p>


<div class="figure">
<p><img src="http://howardism.org/Technical/Emacs/literate-devops-4.png" alt="literate-devops-4.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline7" class="outline-2">
<h2 id="orgheadline7"><span class="section-number-2">5</span> Can you Use the Output?</h2>
<div class="outline-text-2" id="text-5">
<p>
The results of some commands are often needed for the next command, and I’m
sure you just love using your mouse to copy and paste part of the output, but
I have a better way.
</p>

<p>
For instance, I needed a list of an RPM’s dependencies:
</p>


<div class="figure">
<p><img src="http://howardism.org/Technical/Emacs/literate-devops-5.png" alt="literate-devops-5.png" />
</p>
</div>

<p>
Notice I named this source code block. Also notice how Emacs automatically
broke the results up into a table. By default, the output from shell commands
are split along newlines and spaces.
</p>

<p>
I can feed the results of these execution to another code block. The following
source block creates a variable named DEPENDS that uses rows 2 through 10 of
the first column as an array.
</p>


<div class="figure">
<p><img src="http://howardism.org/Technical/Emacs/literate-devops-6.png" alt="literate-devops-6.png" />
</p>
</div>

<p>
I then download the RPMs I want without any mouse interaction.
</p>
</div>
</div>

<div id="outline-container-orgheadline8" class="outline-2">
<h2 id="orgheadline8"><span class="section-number-2">6</span> Setting Variables and Values</h2>
<div class="outline-text-2" id="text-6">
<p>
A key aspect of reusing devops programs (like a Chef cookbooks) is the
separation of the code from the values the code uses…a key aspect of any
program you reuse.
</p>

<p>
In my world, I create a new org-mode file for each sprint, and each task or
problem gets its own header and section. Each section can have a drawer of
properties, including variables shared among all code blocks in that section.
</p>

<p>
To create a section variable, simply hit: C-c C-x p, and set the Property to
var and the value to a variable=value, as in:
</p>

<pre class="example">
host="10.52.224.33"
</pre>

<p>
This drawer can contain any code block values you wish, like session or
results. These values can then be overridden as settings on the code block, as
you see in this screen-shot:
</p>


<div class="figure">
<p><img src="http://howardism.org/Technical/Emacs/literate-devops-8.png" alt="literate-devops-8.png" />
</p>
</div>

<p>
Setting variables and settings (especially the session setting), ties the code
blocks together.
</p>
</div>
</div>

<div id="outline-container-orgheadline9" class="outline-2">
<h2 id="orgheadline9"><span class="section-number-2">7</span> Communicating with Others</h2>
<div class="outline-text-2" id="text-7">
<p>
While investigations in operations and administrations (as I’ve described) are
useful to oneself when understanding the problem domain, I need to communicate
the results with my team mates. Since my <a href="https://github.com/howardabrams/dot-files/blob/master/emacs-mail.org#sending-email">Emacs configuration</a> allows me to send
mail messages, I kick off the function, org-mime-org-buffer-htmlize, which
exports the org-mode file to an HTML mail message (This function is part of
the latest org-plus-contrib package).
</p>

<p>
However, some times the exported results are not quite perfect.
</p>

<p>
For instance, some blocks may result in some JSON data, and since the HTML
output can colorize the syntax, if I could just specify that the output
results were JavaScript, then the JSON data would be much prettier. Just use
the wrap parameter, as in:
</p>

<p>
<img src="http://howardism.org/Technical/Emacs/literate-devops-20.png" alt="literate-devops-20.png" />
<a href="http://howardism.org/Technical/Emacs/literate-devops-20.txt">{litera}</a>
</p>

<p>
Which puts the following in my org-mode file:
</p>

<p>
<img src="http://howardism.org/Technical/Emacs/literate-devops-21.png" alt="literate-devops-21.png" />
<a href="http://howardism.org/Technical/Emacs/literate-devops-21.txt">{litera}</a>
</p>

<p>
Which gets exported like:
</p>

<div class="org-src-container">

<pre class="src src-json"><span style="color: #4f97d7;">{</span><span style="color: #4f97d7; font-weight: bold;">"time"</span>:<span style="color: #bc6ec5;">{</span><span style="color: #4f97d7; font-weight: bold;">"iso"</span>:"<span style="color: #a45bad;">2015</span>-<span style="color: #a45bad;">05</span>-<span style="color: #a45bad;">19T23</span>:<span style="color: #a45bad;">12</span>:<span style="color: #a45bad;">40Z</span>",<span style="color: #4f97d7; font-weight: bold;">"timestamp"</span>:<span style="color: #a45bad;">1432077160</span>,<span style="color: #4f97d7; font-weight: bold;">"date"</span>:"<span style="color: #a45bad;">19</span> May <span style="color: #a45bad;">2015</span>",<span style="color: #4f97d7; font-weight: bold;">"time"</span>:"<span style="color: #a45bad;">7</span>:<span style="color: #a45bad;">12</span> PM"<span style="color: #bc6ec5;">}</span><span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
For another example, my current project involves working with OpenStack, and
its nova command line utility attempts to format the data as a table:
</p>

<div class="org-src-container">

<pre class="src src-org"><span style="text-decoration: line-through;">+--------------------------------------+</span><span style="color: #b2b2b2; background-color: #293239;">--------------------+--------+------------+-------------+------------------------+</span>
<span style="color: #b2b2b2; background-color: #293239;">| ID                                   | Name               | Status | Task State | Power State | Networks               |</span>
<span style="text-decoration: line-through;">+--------------------------------------+</span><span style="color: #b2b2b2; background-color: #293239;">--------------------+--------+------------+-------------+------------------------+</span>
<span style="color: #b2b2b2; background-color: #293239;">| f9e7aed8-e425-4808-aace-8758dadd91bf | chefserver         | ACTIVE | -          | Running     | WPC-private=10.0.1.73  |</span>
<span style="color: #b2b2b2; background-color: #293239;">| 0432f8b1-7e6d-4fc1-b181-02fa768c38ac | ha-compute1        | ACTIVE | -          | Running     | WPC-private=10.0.1.104 |</span>
<span style="color: #b2b2b2; background-color: #293239;">| a5bdd1d0-d4b3-4856-a657-5759356c186b | ha-controller1     | ACTIVE | -          | Running     | WPC-private=10.0.1.97  |</span>
<span style="color: #b2b2b2; background-color: #293239;">| 16263972-609e-44c0-83e0-f3147336071c | ha-controller2     | ACTIVE | -          | Running     | WPC-private=10.0.1.99  |</span>
<span style="color: #b2b2b2; background-color: #293239;">| 89a89d1f-7be5-4c4f-82db-64b751f15f3b | ha-controller3     | ACTIVE | -          | Running     | WPC-private=10.0.1.100 |</span>
<span style="color: #b2b2b2; background-color: #293239;">| b740095a-3f89-45d0-a2a1-9cfcadfb4ca3 | ha-monitoring      | ACTIVE | -          | Running     | WPC-private=10.0.1.95  |</span>
<span style="color: #b2b2b2; background-color: #293239;">| 6bebe823-1504-4cb1-a898-bbc7894b1a32 | ha-sdn-controller1 | ACTIVE | -          | Running     | WPC-private=10.0.1.101 |</span>
<span style="color: #b2b2b2; background-color: #293239;">| 456bf417-580e-49fb-be08-1b0153710f86 | ha-sdn-controller2 | ACTIVE | -          | Running     | WPC-private=10.0.1.102 |</span>
<span style="color: #b2b2b2; background-color: #293239;">| 7aab184c-5fb4-4996-8ab2-8a65ea7668cb | ha-sdn-controller3 | ACTIVE | -          | Running     | WPC-private=10.0.1.103 |</span>
<span style="color: #b2b2b2; background-color: #293239;">| 0c90d7b0-dab4-4af8-a970-e2e90dd8b9e4 | ha-storage-1       | ACTIVE | -          | Running     | WPC-private=10.0.1.76  |</span>
<span style="color: #b2b2b2; background-color: #293239;">| fda0666e-d656-48fd-928f-83fb47c923f2 | ha-storage-2       | ACTIVE | -          | Running     | WPC-private=10.0.1.81  |</span>
<span style="color: #b2b2b2; background-color: #293239;">| 021fc9c1-8d79-4c09-b3d4-6014d242403a | ha-storage-3       | ACTIVE | -          | Running     | WPC-private=10.0.1.96  |</span>
<span style="color: #b2b2b2; background-color: #293239;">| bc5ad0fe-9ef2-4966-8d2b-99892f3f94cd | yum-server         | ACTIVE | -          | Running     | WPC-private=10.0.1.74  |</span>
<span style="text-decoration: line-through;">+--------------------------------------+</span><span style="color: #b2b2b2; background-color: #293239;">--------------------+--------+------------+-------------+------------------------+</span>
</pre>
</div>

<p>
If you manually change the output, those changes will not be honored when the
file is exported (since those are redone during the exporting process).
</p>

<p>
The way to do that is with a little Emacs Lisp code block that you just need
to place somewhere in your file, like:
</p>

<p>
<img src="http://howardism.org/Technical/Emacs/literate-devops-22.png" alt="literate-devops-22.png" />
<a href="http://howardism.org/Technical/Emacs/literate-devops-22.txt">{litera}</a>
</p>

<p>
With this code block named, nova-conv, I can use it to post-process the
results, as in:
</p>

<p>
<img src="http://howardism.org/Technical/Emacs/literate-devops-23.png" alt="literate-devops-23.png" />
<a href="http://howardism.org/Technical/Emacs/literate-devops-23.txt">{litera}</a>
</p>

<p>
In my particular case, I also want to get rid of that first line of dashes to
make it more org-mode like:
</p>

<p>
<img src="http://howardism.org/Technical/Emacs/literate-devops-24.png" alt="literate-devops-24.png" />
<a href="http://howardism.org/Technical/Emacs/literate-devops-24.txt">{litera}</a>
</p>

<p>
To be truly re-useable, place this code in your <a href="http://orgmode.org/manual/Library-of-Babel.html">Library of Babel</a>, and then it
is available from any file.
</p>
</div>
</div>

<div id="outline-container-orgheadline10" class="outline-2">
<h2 id="orgheadline10"><span class="section-number-2">8</span> Summary</h2>
<div class="outline-text-2" id="text-8">
<p>
While my literate devops approach shouldn’t replace real DevOps (OpsDev?)
automation, I have found this approach useful for two reasons:
</p>

<ol class="org-ol">
<li>As a good way to take notes before writing a cookbook.</li>
<li>As an easy approach to compose emails to teammates when stuck.</li>
</ol>

<p>
Regarding the last point, I often write my literate files in the past tense,
even before I write and execute the code, as in:
</p>

<p>
<img src="http://howardism.org/Technical/Emacs/literate-devops-25.png" alt="literate-devops-25.png" />
<a href="http://howardism.org/Technical/Emacs/literate-devops-25.txt">{litera}</a>
</p>

<p>
Then, if the command or process I’m following fails, I can simply high-light a
section of my document, hit C-x M to email an exported HTML version to the
rest of the team (otherwise, I’d spend hours copy/pasting back from the
terminal in order to provide sufficient context for the email).
</p>

<p>
Need a complete example? Check out my <a href="http://howardism.org/Technical/Emacs/linux-iptables.html">notes on setting up IP Tables</a> (and the 
<a href="http://howardism.org/Technical/Emacs/linux-iptables.org.txt">original org-mode file</a>), where part of the file can be executed in the editor
in order to see how my machines are configured, and the other part is a script
that can be tangled to a machine and executed to reset to the firewall rules.
</p>

<p>
Thanks for reading.
</p>
</div>
</div>

<div id="outline-container-orgheadline11" class="outline-2">
<h2 id="orgheadline11"><span class="section-number-2">9</span> Footnotes:</h2>
<div class="outline-text-2" id="text-9">
<p>
^<a href="http://howardism.org/Technical/Emacs/literate-devops.html#fnr.1">1</a>
</p>

<p>
For each new sprint, I create an <a href="http://orgmode.org/">org-mode formatted file</a> to keep track of
tasks, notes, and other details. This makes it ideal for embedding a bit of 
literate devops.
</p>

<p>
^<a href="http://howardism.org/Technical/Emacs/literate-devops.html#fnr.2">2</a>
</p>

<p>
Every operating system creates temporary files in different directory
locations. Most Unix systems, use <i>tmp</i>, but Macs use <i>var/folders</i>. The
current org-mode code uses the same directory name on the remote system that
would work on the local system. In my case, I’m using my Mac laptop at work to
connect to a Linux system in my data center, and I get the following error:
</p>

<pre class="example">
Tramp: Decoding remote file `/ssh:x.y.z:/var/folders/0s/pcrc3rq5075gj4tm90pbh76c36sl1h/T/ob-input-32379ujY' using `base64 -d -i &gt;%s'...failed
byte-code: Couldn't write region to `/ssh:x.y.z:/var/folders/0s/pcrc3rq5075gj4tm90pbh76c36sl1h/T/ob-input-32379ujY', decode using `base64 -d -i &gt;%s' failed
</pre>

<p>
The bug is in org-mode version 8.2.10 (and probably earlier), as I found in 
<a href="http://lists.gnu.org/archive/html/emacs-orgmode/2013-09/msg00992.html">this mailing list posting</a> (and it may not be fixed for a while since it isn’t
real clear what the best solution would be). To fix it yourself, edit
ob-core.el file in the org-babel-temp-file function to be:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defun</span> <span style="color: #bc6ec5; font-weight: bold;">org-babel-temp-file</span> <span style="color: #bc6ec5;">(</span>prefix <span style="color: #ce537a; font-weight: bold;">&amp;optional</span> suffix<span style="color: #bc6ec5;">)</span>
  <span style="color: #2aa1ae;">"Create a temporary file in the `</span><span style="color: #a45bad;">org-babel-temporary-directory</span><span style="color: #2aa1ae;">'.</span>
<span style="color: #2aa1ae;">Passes PREFIX and SUFFIX directly to `</span><span style="color: #a45bad;">make-temp-file</span><span style="color: #2aa1ae;">' with the</span>
<span style="color: #2aa1ae;">value of `</span><span style="color: #a45bad;">temporary-file-directory</span><span style="color: #2aa1ae;">' temporarily set to the value</span>
<span style="color: #2aa1ae;">of `</span><span style="color: #a45bad;">org-babel-temporary-directory</span><span style="color: #2aa1ae;">'."</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>file-remote-p default-directory<span style="color: #2d9574;">)</span>
      <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>prefix
             <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">We cannot use `</span><span style="color: #a45bad; background-color: #292e34;">temporary-file-directory</span><span style="color: #2aa1ae; background-color: #292e34;">' as local part</span>
             <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">on the remote host, because it might be another OS</span>
             <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">there.  So we assume "/tmp", which ought to exist on</span>
             <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">relevant architectures.</span>
             <span style="color: #4f97d7;">(</span>concat <span style="color: #bc6ec5;">(</span>file-remote-p default-directory<span style="color: #bc6ec5;">)</span>
                     <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">REPLACE temporary-file-directory with /tmp:</span>
                     <span style="color: #bc6ec5;">(</span>expand-file-name prefix <span style="color: #2d9574;">"/tmp/"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span>make-temp-file prefix nil suffix<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>temporary-file-directory
           <span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">or</span> <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">and</span> <span style="color: #2d9574;">(</span>boundp 'org-babel-temporary-directory<span style="color: #2d9574;">)</span>
                    <span style="color: #2d9574;">(</span>file-exists-p org-babel-temporary-directory<span style="color: #2d9574;">)</span>
                    org-babel-temporary-directory<span style="color: #bc6ec5;">)</span>
               temporary-file-directory<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span>make-temp-file prefix nil suffix<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
^<a href="http://howardism.org/Technical/Emacs/literate-devops.html#fnr.3">3</a>
</p>

<p>
If you install the <a href="https://github.com/ieure/ssh-el#start-of-content">ssh.el</a> project, you would initially connect to your remote
system using: M-x ssh
</p>

<p>
You would then enter the host connection information, including the password
(if needed), etc. For instance, if I connected to my host:
goblin.howardism.org, then my code blocks would refer to a session like this:
</p>

<div class="org-src-container">

<pre class="src src-org"><span style="color: #827591; background-color: #373040;">#+begin_src sh :session *ssh goblin.howardism.org* :var dir="/opt"</span>
   ls $<span style="color: #7590db;">dir</span>
<span style="color: #827591; background-color: #373040;">#+end_src</span>
</pre>
</div>

<p>
This is allows you to watch your code execute on the remote system, but still
allow a fully functional code blocks that can read values from other parts of
the org-mode file.
</p>

<p>
Note: The value to the session parameter is surrounded by * characters (part
of the buffer name), but the variables you want to pass in are surrounded by
quotes (otherwise, they are interpreted as named references to tables
elsewhere in the document).
</p>

<p>
^<a href="http://howardism.org/Technical/Emacs/literate-devops.html#fnr.4">4</a>
</p>

<p>
I have a third way of executing remote commands, and this uses the ob-screen
extension (located in the <a href="http://orgmode.org/worg/org-contrib/">org-mode Contrib</a> collection). It uses both Gnu
screen and xterm, so on my Mac, I start XQuartz (the built-in X Windows
emulator), and add the following to my .emacs initialization (based on <a href="http://orgmode.org/worg/org-contrib/babel/languages/ob-doc-screen.html">these</a>
<a href="http://orgmode.org/worg/org-contrib/babel/languages/ob-doc-screen.html">instructions</a>) to set the full path to my xterm program:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">setq</span> org-babel-default-header-args:screen
      '<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #4f97d7;">:results</span>  . <span style="color: #2d9574;">"silent"</span><span style="color: #2d9574;">)</span>
        <span style="color: #2d9574;">(</span><span style="color: #4f97d7;">:session</span>  . <span style="color: #2d9574;">"default"</span><span style="color: #2d9574;">)</span>
        <span style="color: #2d9574;">(</span><span style="color: #4f97d7;">:cmd</span>      . <span style="color: #2d9574;">"bash"</span><span style="color: #2d9574;">)</span>
        <span style="color: #2d9574;">(</span><span style="color: #4f97d7;">:terminal</span> . <span style="color: #2d9574;">"/opt/X11/bin/xterm"</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
I don’t often use screen, but I install using Homebrew:
</p>

<div class="org-src-container">

<pre class="src src-sh">brew install screen
</pre>
</div>

<p>
And then tell ob-screen how to find it:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">setq</span> org-babel-screen-location <span style="color: #2d9574;">"/usr/local/bin/screen"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
The code blocks are now specified as screen, and I typically specify which
xterm window to use by setting the :session parameter:
</p>

<div class="org-src-container">

<pre class="src src-org"><span style="color: #827591; background-color: #373040;">#+BEGIN_SRC screen :session blah</span>
ls /Applications

<span style="color: #827591; background-color: #373040;">#+END_SRC</span>
</pre>
</div>

<p>
The results do not get placed into my Emacs file buffer, but are simply left,
as is, in the xterm window.
</p>

<p>
The other down-side to using screen is it doesn’t pass in variables. For
instance, the following doesn’t work:
</p>

<div class="org-src-container">

<pre class="src src-org"><span style="color: #827591; background-color: #373040;">#+begin_src screen :session blah :var dir="/Applications"</span>
ls $<span style="color: #7590db;">dir</span>

<span style="color: #827591; background-color: #373040;">#+end_src</span>
</pre>
</div>

<p>
Seeing the back-and-forth results in the xterm window is nice, but not being
able to bring the results back into the file for further processing is
limited. Also, you must resist the temptation to fix a command by typing in
the xterm window. If you go down that path, you may forget to put that
information back into your org-mode file, and may regret it later.
</p>
</div>
</div>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2016-10-31</span>
            <span title="last modification date" class="post-info">2016-10-31</span>
            <span title="tags" class="post-info">:N/A:</span>
            <span title="author" class="post-info"><a href="mailto:lujun9972 &lt;at&gt; lujun9972-desktop">lujun9972</a></span>
        </div>
    <script src="http://lujun9972.github.io/emacs-document/media/js/jquery-2.1.3.min.js"></script>
        <section>
            <h1>Comments</h1>
            <div id="comment-wrap">
                    <a class="disqus_label">使用 Disqus 评论</a>
                    <a class="ds-label">使用多说评论</a>
    </ul>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
         //var disqus_developer = 1;
         var preempt_signal=false;
         var disqus_identifier = "/blog/2016/10/31/literate-devops/";
         var disqus_url = "http://lujun9972.github.io/emacs-document/blog/2016/10/31/literate-devops/";
         var disqus_shortname = 'emacs-document';
         /* * * DON'T EDIT BELOW THIS LINE * * */
         (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
             $('#disqus_thread').css('display','none');
         })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <div class="ds-thread"></div>
        <script type="text/javascript">
         var duoshuoQuery = {short_name:'emacs-document'};
         (function() {
             var ds = document.createElement('script');
             ds.type = 'text/javascript';ds.async = true;
             ds.src = 'http://static.duoshuo.com/embed.js';
             ds.charset = 'UTF-8';
             (document.getElementsByTagName('head')[0]
           || document.getElementsByTagName('body')[0]).appendChild(ds);
             $('.ds-thread').css('display','block');
         })();
        </script>
    <script>
     /* comments */
     var ego_disqus_thread=$('#disqus_thread');
     var ego_ds_label=$('.ds-thread');
     $('.disqus_label').click(function(){
         ego_disqus_thread.show();
         ego_ds_label.hide();
     });
     $('.ds-label').click(function(){
         ego_disqus_thread.hide();
         ego_ds_label.show();
     });
    </script>
        </section>
    <script src="http://lujun9972.github.io/emacs-document/media/js/main.js"></script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.x(<a href="http://orgmode.org">Org mode</a> 8.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:lujun9972 &lt;at&gt; lujun9972-desktop">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div></body>
</html>
